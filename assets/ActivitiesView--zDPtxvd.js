import{_ as Y}from"./BaseAdvanceFilter.vue_vue_type_script_setup_true_lang-CFEKA_bL.js";import{D as O,E as U,p as z,s as J,k as K,d as $,c as _,e as o,f as u,w as c,o as f,T as G,l as L,g as d,F as R,H as S,a as r,x as P,t as C,m as N,r as A,q as V,y as Q,I as W,n as X}from"./index-BGjygZi6.js";import{M as Z,L as q}from"./metaPagination-9MSE0uSw.js";import{o as k,s as g,r as ee,n as j,b as te,a as M,c as se}from"./types-CVZIcfwR.js";import{A as F}from"./api.schema-B7NsqcGR.js";import{f as ae}from"./dateRangeFormaterNaive-ClR-GZjc.js";import{H as ie,A as ne}from"./HomeOutline-C1z2fqd1.js";import"./BaseButton.vue_vue_type_script_setup_true_lang-WC2rZVzv.js";import"./BaseInput.vue_vue_type_script_setup_true_lang-BU0nAdgp.js";import"./SearchOutline-SINafxgf.js";import"./DocumentExport-Bx94nO8O.js";import"./RefreshRound-BRsK8zsJ.js";const D=new Date,oe=D.getFullYear();D.getMonth();const le=k({id:j(),description:g().nullable().optional(),logName:g().nullable().optional(),subjectType:g().nullable().optional(),event:g().nullable().optional(),properties:ee(te()).or(k({}).passthrough()).nullable().optional(),batchUuid:g().nullable().optional(),causer:g().nullable().optional(),time:g()}),I=k({date:g().regex(/^\d{4}-\d{2}-\d{2}$/),total:j().int().nonnegative(),items:M(le)});M(I);const re=k({message:g(),data:M(I),links:q,meta:Z,status:se()}),ce=O("activities",{state:()=>({data:[],searchResult:[],isSearching:!1,meta:{},links:{},loading:!1,error:null,currentPage:1,lastPage:1,search:"",isFirstLoad:!0}),actions:{async fetchActivities(t=1,s,l,a,h){this.loading=!0,this.error=null;try{s&&(this.searchResult=[],this.isSearching=!0);const p=await U.get("/api/activities",{params:{page:t,name:s,dateFrom:l,dateTo:a,year:h}}),n=re.parse(p.data);return this.meta=n.meta,this.links=n.links,this.currentPage=n.meta.currentPage,this.lastPage=n.meta.lastPage,s?this.searchResult=n.data:(t===1?this.data=n.data:n.data.forEach(m=>{const i=this.data.findIndex(e=>e.date===m.date);if(i!==-1){const e=this.data[i];this.data[i]={...e,items:[...e.items,...m.items],total:e.total+m.total}}else this.data.push(m)}),this.isSearching=!1,this.searchResult=[]),F.parse({success:!0,message:n.message??"Activities loaded"})}catch(p){const n=p?.response?.data?.message||"Something went wrong";return this.error=n,F.parse({success:!1,message:n})}finally{this.loading=!1,this.isFirstLoad=!1}},async searchOrFetch(t){if(this.search!==t&&(this.searchResult=[],this.isSearching=!1),this.search=t,!t)return await this.fetchActivities(1),this.data;const s=this.data.map(a=>({...a,items:a.items.filter(h=>h.description?.toLowerCase().includes(t.toLowerCase())||h.logName?.toLowerCase().includes(t.toLowerCase()))})).filter(a=>a.items.length>0);return s.length>0?(this.searchResult=s,this.isSearching=!0,s):(await this.fetchActivities(1,t)).success?this.searchResult:[]},async loadNextPage(){return this.currentPage<this.lastPage?await this.fetchActivities(this.currentPage+1):F.parse({success:!1,message:"Request is already in progress"})}},getters:{searchedItems:t=>{if(!t.search)return t.data;if(t.isSearching&&t.searchResult.length)return t.searchResult;const s=t.search.toLowerCase();return t.data.map(l=>({...l,items:l.items.filter(a=>a.description?.toLowerCase().includes(s)||a.logName?.toLowerCase().includes(s))})).filter(l=>l.items.length>0)}}});function H(){const t=z(),s=ce(),{search:l,loading:a,isFirstLoad:h}=J(s),p=K(()=>s.searchedItems);return{search:l,data:p,isLoading:a,isFirstLoad:h,handleFetchActivity:async(i={})=>{const{success:e,message:y}=await s.fetchActivities(i.page??1,i.name,i.dateFrom,i.dateTo,i.year);e||t.error(y)},handleLoadMore:async()=>{const{success:i,message:e}=await s.loadNextPage();i?t.success(e):t.error(e)}}}const de={class:"flex gap-2 item-center"},ue={class:"flex-1"},me={class:"space-y-2"},he={key:0,class:"text-gray-500"},pe={class:"flex gap-2 item-center"},fe={class:"flex-1"},ge={class:"flex-1 mt-2 text-gray-500"},_e={class:"border-l-4 pl-2 mb-5"},ye=$({__name:"ActivitiesTimeLine",setup(t){const{data:s,isLoading:l,isFirstLoad:a,handleLoadMore:h}=H();return(p,n)=>{const m=u("NSkeleton"),i=u("n-card"),e=u("n-timeline-item"),y=u("n-empty"),w=u("JsonViewer"),T=u("n-timeline"),v=u("n-button"),B=u("center"),E=u("n-space");return f(),_("div",null,[o(E,{size:20,vertical:"",justify:"center"},{default:c(()=>[o(T,null,{default:c(()=>[o(G,{name:"fade",tag:"div"},{default:c(()=>[d(a)&&d(l)?(f(),_(R,{key:0},S(5,x=>o(e,{key:x},{default:c(()=>[r("div",de,[r("div",ue,[o(m,{animated:"",class:"mb-2"}),o(m,{animated:""})]),o(i,{class:"flex-5"},{default:c(()=>[o(m,{height:"100px",animated:""})]),_:1})])]),_:2},1024)),64)):!d(l)&&d(s).length===0&&!d(a)?(f(),L(y,{key:1,size:"huge",class:"text-center",description:"No activities found"},{extra:c(()=>[r("div",me,[d(a)?P("",!0):(f(),_("p",he,"Try adjusting your search terms or filters "))])]),_:1})):(f(!0),_(R,{key:2},S(d(s),x=>(f(),L(e,{key:x.date,title:x.date},{default:c(()=>[(f(!0),_(R,null,S(x.items,b=>(f(),_("div",{key:b.id,class:"mb-10"},[r("div",pe,[r("div",fe,[r("p",null,C(b.causer),1),r("p",ge,C(b.time),1)]),o(i,{class:"flex-5"},{default:c(()=>[r("p",_e,C(b.description),1),o(w,{value:b.properties,copyable:"",boxed:"",sort:"",theme:"dark"},null,8,["value"])]),_:2},1024)])]))),128))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}),o(B,null,{default:c(()=>[!d(a)&&d(s).length!=0?(f(),L(v,{key:0,class:"p-20",onClick:d(h)},{default:c(()=>[...n[0]||(n[0]=[N(" Load More ",-1)])]),_:1},8,["onClick"])):P("",!0)]),_:1})]),_:1})])}}}),ve={class:"flex flex-col gap-5"},xe={class:"flex justify-between items-center"},be={class:"w-36 flex-auto text-right"},we={class:"flex justify-between bg-gray-100 border border-gray-200 rounded-lg p-2"},$e=$({__name:"ActivitiesView",setup(t){const{search:s,handleFetchActivity:l}=H(),a=A(null),h=A(oe),p=A(null),n=A(null),m=()=>{alert("this feature coming soon")};return V(a,i=>{if(i){const e=ae(i);e?(p.value=e[0],n.value=e[1],l({dateFrom:e[0],dateTo:e[1]})):(p.value=null,n.value=null)}else p.value=null,n.value=null}),V(h,i=>{l({year:i})}),Q(async()=>{await l()}),W({title:"Audit Trail",meta:[{name:"description",content:"This module records, stores, and displays all user activities within the application. Key actions such as login, data updates, entity creation or deletion, and administrative operations are logged in detail to support auditing, monitoring, and system security."}]}),(i,e)=>{const y=u("n-icon"),w=u("n-breadcrumb-item"),T=u("n-breadcrumb");return f(),_("div",ve,[r("div",xe,[e[4]||(e[4]=r("div",{class:"w-64 flex-auto"},[r("h2",{class:"text-xl font-bold mb-1"},"Audit Trail"),r("p",null,"This module records, stores, and displays all user activities within the application. Key actions such as login, data updates, entity creation or deletion, and administrative operations are logged in detail to support auditing, monitoring, and system security.")],-1)),r("div",be,[o(T,null,{default:c(()=>[o(w,null,{default:c(()=>[o(y,{component:d(ie)},null,8,["component"]),e[2]||(e[2]=N(" Home",-1))]),_:1}),o(w,null,{default:c(()=>[o(y,{component:d(ne)},null,8,["component"]),e[3]||(e[3]=N(" Audit Trails ",-1))]),_:1})]),_:1})])]),r("div",we,[o(Y,{modelValue:d(s),"onUpdate:modelValue":e[0]||(e[0]=v=>X(s)?s.value=v:null),dateRange:a.value,"onUpdate:dateRange":e[1]||(e[1]=v=>a.value=v),"onClick:export":m},null,8,["modelValue","dateRange"]),e[5]||(e[5]=r("div",null,null,-1))]),o(ye)])}}});export{$e as default};
